---
title: "Downstream analyses (all)"
output:
  html_document:
    theme: cerulean
  pdf_document: default
---

<style type="text/css">
body, td{ font-size: 18px; }
code.r{ font-size: 12px; }
pre { font-size: 12px }
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(comment = NA)
```

### Features in cic_clinical_data_v2.xlsx (summary sheet):

```{r}
# load each sheet from cic_clinical_data_v2.xlsx
setwd("/Users/ummz/Documents/OneDrive - University of Leeds/data/metadata/cic_clinical_data_v2_split/")
sheet_1 <- read.csv("cic_clinical_data_v2_summary.csv")               # 41 x 19
sheet_2 <- read.csv("cic_clinical_data_v2_TABUL_clinical_data.csv", header = FALSE)   # 36 x 142; there's double header
sheet_3 <- read.csv("cic_clinical_data_v2_TABUL_steroid_data.csv")    # 67 x 6
sheet_4 <- read.csv("cic_clinical_data_v2_UK_GCA_clinical_data.csv")  # 7 x 149 => unimportant 
```

```{r, echo=TRUE}
colnames(sheet_1)
```

Total number of cases: 41 for each feature (some might contain missing data)

How many class (levels) for each feature?

```{r}
# check how many class (levels) for each feature
out_1 <- list()
for (i in 1:ncol(sheet_1)) {
  out_1[i] <- unique(sheet_1[i])
}

unlist(lapply(out_1, length))
```

NOTE: 1st and 2nd columns (`r colnames(sheet_1[1])` & `r colnames(sheet_1[2])`) can be ignored as they have 41 levels, as well as, 5th and 6th (`r colnames(sheet_1[5])` & `r colnames(sheet_1[6])`) as they have 1 level only.

```{r}
# create sheet_1_bis and out_1_bis where 1, 2, 5 and 6 columns will not be included.
sheet_1_bis <- sheet_1[-c(1,2,5,6)]
out_1_bis <- out_1[-c(1,2,5,6)]
```

How many cases in each class?  

OUTPUT EXAMPLE
```{r}
cat("### Feature: [name_of_clinical_feature] ### \n Class: [X] => count: [Y] \n")
cat("\n")
```

```{r}
# How many cases in each class?
for (i in 3:ncol(sheet_1_bis)) {
  cat("###", colnames(sheet_1_bis[i]), "###\n")
  for (j in 1:length(out_1_bis[[i]])) {
    cat(out_1_bis[[i]][j], "=> ", length(which(as.character(out_1_bis[[i]][j]) == sheet_1_bis[i])), "\n")
  }
  cat("\n")
}
```

```{r}
if(FALSE){
# Visual loss at BL = reduced or lost vision (temporary or permanent) pre steroids or at BL assessment or AION or PION 
# Jaw claudication at BL = present pre steroids or at baseline assessment visit
# Ischaemic features at BL = jaw claudication, tongue claudication or visual loss (temporary or permanent) pre steroids or at baseline
  
# for columns 3-9: 0 - NO | 1 - YES
# for columns 5-6: 99 - not assessed
# for column 9: 2 - unknown
# for column 10: 1 - male | 2 - female
}
```

Features to be taken into account in the analysis of clinical summary:  
 
* **Myriad** (15 -- 26) => ???
* **Batch** (26 -- 15) => same as **gender**, except for 16649
* **visual.loss.at.BL** (24 -- 17) => same as **visual.loss.ever** => OK
* **AION.or.PION.BL** (10 -- 5 | 26 not assessed) => almost the same as **AION.or.PION.ever**; uninformative
* **jaw.claudication.at.BL** (17 -- 24) => OK
* **ischaemic.features.at.BL** (10 -- 31) => OK
* **tongue.claudication** (35 -- 5 | 1 unknown) => probably uninformative
* **year.TAB.sample.was.collected** (2006:1 -- 2010:2 -- 2011:7 -- 2012:18 -- 2013:12 -- 2015:1) => not sure 
* **number.of.days.on.steroids.at.TAB** (1:2 -- 2:1 -- 3:2 -- 4:1 -- 5:8 -- 6:5 -- 7:3 -- 8:6 -- 9:9 -- 10:2 -- 11:1 -- 12:1) 
* **number.of.days.between.TAB.and.BL.blood.sample** (1:1 -- 2:5 -- 3:7 -- 4:1 -- 5:1 -- 6:1 -- 7:5 -- 8:2 -- 9:4 -- 10:4 -- 11:6 -- 12:2 -- 13:1 -- 14:1)

```{r}
#### NOTICE: the other three sheets are not important for now 
# cic_clinical_data_v2_TABUL_clinical_data.csv   (sheet_2)
# cic_clinical_data_v2_TABUL_steroid_data.csv    (sheet_3)
# cic_clinical_data_v2_UK_GCA_clinical_data.csv  (sheet_4)
```

```{r}
# there's double header so it need to be fixed
#sheet_2_mod <- sheet_2[-c(1,2),]

#mat_temp <- as.matrix(sheet_2)
#colnames(sheet_2_mod) <- as.character(mat_temp[2,])

# match 'study ID' with 'database code' from Summary
# keep only samples that are present in sheet_1 (i.e. from my cohort)
# it includes 35 common samples with sheet_1
# 6 are missing: 12331, 12330, 14455, 11026, 11028, 8546

# add "database.code" that matches with `Study ID`

```

```{r}
# match 'study ID' with 'database code' from Summary
# keep only samples that are present in sheet_1 (i.e. from my cohort)
#to_be_kept_s3 <- which(as.character(sheet_1$Study.ID) %in% as.character(sheet_3$Study.ID)) # 20

#sheet_3_final <- sheet_3[to_be_kept_s3,]

# add "database.code" that matches with "Study.ID"

# there are duplicated rows; all study ID's in sheet_3 are included in sheet_1
#unique(sheet_3$Study.ID) == intersect(as.character(sheet_1$Study.ID), as.character(sheet_3$Study.ID))
```

```{r}
# load slide_scores_v6.csv
setwd("/Users/ummz/Documents/OneDrive - University of Leeds/data/metadata/")
slide_sc <- read.csv("slide_scores_v6.csv")                           # 40 x 25
```

### Features in slide_scores_v6.csv:

```{r, echo=TRUE}
colnames(slide_sc) # dim = 40 25; one sample is missing
```

Total number of cases: 40 for each feature (some might contain missing data)

How many class (levels) for each feature?

```{r}
# check how many class (levels) for each feature
out_sc <- list()
for (i in 1:ncol(slide_sc)) {
  out_sc[i] <- unique(slide_sc[i])
}

unlist(lapply(out_sc, length))
```

NOTE: 1st column (`r colnames(slide_sc[1])`) can be ignored as it has 40 levels, as well as, 2nd and 6th (`r colnames(slide_sc[2])` & `r colnames(slide_sc[6])`) as they have 1 level only.

```{r}
# create sheet_1_bis and out_1_bis where 1, 2, 5 and 6 columns will not be included.
slide_sc_bis <- slide_sc[-c(1,2,6)]
out_sc_bis <- out_sc[-c(1,2,6)]
```

How many cases in each class?  

```{r}
# How many cases in each class?
for (i in 3:ncol(slide_sc_bis)) {
  cat("###", colnames(slide_sc_bis[i]), "###\n")
  for (j in 1:length(out_sc_bis[[i]])) {
    cat(out_sc_bis[[i]][j], "=> ", length(which(as.character(out_sc_bis[[i]][j]) == slide_sc_bis[i])), "\n")
  }
  cat("\n")
}
```

Features to be taken into account in the analysis of slide scores:

* **Granulomatous.infiltrate.in.adventitia** (38 -- 2) 
* **Granulomatous.infiltrate.in.intima** (39 -- 1)
* **Any.lymphocytic.infiltrate** (0 -- 32)
* **X (missing feature name)** (8 -- 32)
* **Lymphocytic.infiltrate.in.media** (12 -- 28) => OK
* **Lymphocytic.infiltrate.in.intima** (9 -- 31) => OK
* **Barcelona.score** (0:8 -- 2:1 -- 3:6 -- 4:25)
* **Adventitia.pattern** (0:8 -- 2:8 -- 3:24)
* **Media.pattern** (0:14 -- 1:7 -- 2:13 -- 3:6)
* **Intima.pattern** (0:9 -- 1:8 -- 2:15 -- 3:8)
* **Giant.cells** (30 -- 10) => do PCA
* **Aggregates** (36 -- 4)
* **Infiltrate.around.vasa.vasorum** (23 -- 17) => OK
* **PALI** (35 -- 5)
* **Media.destruction** (19 -- 21) => do PCA
* **Neoangiogenesis** (29 -- 11) => do PCA
* **Hyperplasia** (8 -- 32)
* **Fibrosis** (9 -- 31)
* **Oedema** (35 -- 5) 
* **Occlusion.grade** (0:9 -- 1:3 -- 2:6 -- 3:21 -- 4:1)

### Batch effects 

```{r,out.width="60%",out.height="40%",fig.cap="Principal Components Analysis",fig.show='hold',fig.align='center'}

knitr::include_graphics("/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/batch_effect/PCA_batch_effect_PE_outliers_labelled.jpg")
``` 

There's one obvious outlier (8546) and 6 other (12331, 12388, 14914, 14925, 16098, 16649). check QC scores for these samples and complete here

### Comparison between gender 

```{r,out.width="49%",out.height="20%",fig.cap="Comparison between gender - PCA",fig.show='hold',fig.align='center'}

knitr::include_graphics(c("/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/gender/PCA_gender_PE_PC1vsPC2.jpg", "/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/gender/PCA_gender_PE_PC3vsPC4.jpg"))
``` 

Variance explained:  
**PC1: 20.7%** | **PC2: 10.2%** | **PC3: 8.7%** | **PC4: 6.5%**  

### clincial features:  
#### visual.loss.at.BL 
```{r,out.width="49%",out.height="20%",fig.cap="Visual loss at BL - PCA",fig.show='hold',fig.align='center'}

knitr::include_graphics(c("/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/visual_loss/PCA_visual_loss_PE_PC1vsPC2.jpg", "/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/visual_loss/PCA_visual_loss_PE_PC3vsPC4.jpg"))
``` 

#### jaw.claudication.at.BL 
```{r,out.width="49%",out.height="20%",fig.cap="Jaw claudication at BL - PCA",fig.show='hold',fig.align='center'}

knitr::include_graphics(c("/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/jaw_claudication/PCA_jaw_claudication_PE_PC1vsPC2.jpg", "/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/jaw_claudication/PCA_jaw_claudication_PE_PC3vsPC4.jpg"))
``` 

#### ischaemic.features.at.BL
```{r,out.width="49%",out.height="20%",fig.cap="Ischaemic features at BL - PCA",fig.show='hold',fig.align='center'}

knitr::include_graphics(c("/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/ischaemic_features/PCA_ischaemic_features_PE_PC1vsPC2.jpg", "/Users/ummz/OneDrive - University of Leeds/ANALYSES/results_run_IV_Feb20/6_downstream_analysis/paired-end/ischaemic_features/PCA_ischaemic_features_PE_PC3vsPC4.jpg"))
``` 







